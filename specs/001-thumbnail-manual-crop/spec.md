# 功能规格说明：缩略图手动裁剪标记

**功能分支**: `001-thumbnail-manual-crop`  
**创建日期**: 2026-02-08  
**状态**: 草稿  
**输入**: 用户描述: "标记手动裁剪还是自动裁剪，如果是手动裁剪过的，就不需要再自动裁剪了，自动有扫描的时候，也有批量的时候"

## 用户场景与测试 *(必填)*

### 用户故事 1 - 手动裁剪标记保护（优先级：P1）

用户对某本书的缩略图手动执行裁剪（选择保留左半或右半），系统记住这是手动裁剪。之后无论是扫描自动裁剪还是批量自动裁剪，都跳过该书，不会覆盖用户的选择。

**为什么是这个优先级**: 这是核心需求，直接保护用户的手动操作不被系统自动操作覆盖。

**独立测试**: 可以通过手动裁剪一本书的缩略图，然后触发批量裁剪或重新扫描，验证该书缩略图未被改变来完全测试。

**验收场景**:

1. **给定** 一本书的缩略图未被裁剪，**当** 用户在书籍菜单中点击"裁剪左半为封面"，**那么** 缩略图被裁剪，且标记为手动裁剪
2. **给定** 一本书的缩略图已被手动裁剪，**当** 系统执行批量自动裁剪双页封面，**那么** 该书被跳过，缩略图保持不变
3. **给定** 一本书的缩略图已被手动裁剪，**当** 系统扫描并重新生成缩略图，**那么** 新生成的缩略图不会自动成为选中状态，手动裁剪的缩略图保持选中

---

### 用户故事 2 - 系列级手动裁剪（优先级：P1）

用户对整个系列执行裁剪操作，系统为该系列中每本书的缩略图都标记为手动裁剪。

**为什么是这个优先级**: 系列裁剪是用户常用的批量手动操作，与单本裁剪同等重要。

**独立测试**: 可以通过对一个系列执行裁剪，然后触发全局批量裁剪，验证该系列所有书的缩略图都未被改变。

**验收场景**:

1. **给定** 一个系列包含5本书，**当** 用户在系列菜单中点击"裁剪左半为封面"，**那么** 5本书的缩略图都被裁剪并标记为手动裁剪
2. **给定** 该系列已被手动裁剪，**当** 执行全局批量裁剪，**那么** 5本书全部被跳过

---

### 用户故事 3 - 恢复缩略图清除标记（优先级：P2）

用户可以恢复缩略图到原始状态，恢复后手动裁剪标记被清除，允许自动裁剪再次生效。

**为什么是这个优先级**: 恢复操作是手动裁剪的逆操作，确保用户可以撤销决定。

**独立测试**: 可以通过手动裁剪一本书、恢复缩略图、再触发自动裁剪来验证自动裁剪重新生效。

**验收场景**:

1. **给定** 一本书的缩略图已被手动裁剪，**当** 用户点击"恢复缩略图"，**那么** 缩略图恢复为原始封面，手动裁剪标记被清除
2. **给定** 恢复后的书，**当** 系统执行批量自动裁剪，**那么** 该书不再被跳过，正常参与自动裁剪

---

### 用户故事 4 - 编辑对话框裁剪标记（优先级：P2）

用户在编辑书籍对话框中的缩略图标签页执行裁剪，同样标记为手动裁剪。

**为什么是这个优先级**: 编辑对话框是另一个手动裁剪入口，需要与菜单裁剪行为一致。

**独立测试**: 可以通过在编辑对话框中裁剪缩略图，然后验证标记被设置。

**验收场景**:

1. **给定** 用户打开书籍编辑对话框，**当** 在缩略图标签页点击"裁剪左半为封面"或"裁剪右半为封面"，**那么** 裁剪执行且标记为手动裁剪

---

### 边界情况

- 当用户先手动裁剪左半，然后通过系列裁剪选择右半时，新的手动裁剪覆盖旧的（仍标记为手动裁剪）
- 当书的封面不是双页展开时，裁剪操作本身已有跳过逻辑，手动裁剪标记不影响此判断
- 当缩略图被用户上传（USER_UPLOADED 类型）时，自动裁剪已经不会覆盖它，手动裁剪标记仅影响 GENERATED 类型的缩略图

## 需求 *(必填)*

### 功能需求

- **FR-001**: 系统**必须**在缩略图数据中维护一个手动裁剪标记（manualCrop），区分手动裁剪和自动裁剪
- **FR-002**: 用户通过单本书裁剪（菜单或编辑对话框）时，系统**必须**将生成的缩略图标记为手动裁剪
- **FR-003**: 用户通过系列裁剪时，系统**必须**将该系列每本书的缩略图标记为手动裁剪
- **FR-004**: 批量自动裁剪（全局裁剪双页封面）时，系统**必须**跳过已标记为手动裁剪的书
- **FR-005**: 扫描重新生成缩略图时，系统**必须**不自动选中新缩略图来替换已标记手动裁剪的缩略图
- **FR-006**: 用户执行"恢复缩略图"操作时，系统**必须**清除手动裁剪标记
- **FR-007**: 手动裁剪标记**必须**持久化到数据库，重启后保留

### 关键实体

- **ThumbnailBook**: 书籍缩略图，新增 `manualCrop` 布尔属性。当用户主动裁剪时设为 true，恢复时设为 false。自动裁剪流程检查此属性决定是否跳过。

## 成功标准 *(必填)*

### 可测量结果

- **SC-001**: 手动裁剪过的书在批量自动裁剪时100%被跳过，缩略图不发生变化
- **SC-002**: 手动裁剪过的书在扫描重新生成缩略图后，选中的缩略图仍为手动裁剪的版本
- **SC-003**: 恢复缩略图后，该书在下次自动裁剪时能正常被处理
- **SC-004**: 所有手动裁剪入口（单本菜单、系列菜单、编辑对话框）都正确设置标记
